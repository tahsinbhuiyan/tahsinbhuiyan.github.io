<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Advanced 3D Car Game</title>
<style>
body{margin:0;overflow:hidden;background:#000;font-family:sans-serif;}
#hud{position:fixed;top:10px;left:10px;color:#fff;z-index:10;font-size:14px;}
#btns{position:fixed;bottom:20px;width:100%;display:flex;justify-content:center;z-index:10;}
.button{width:70px;height:70px;border-radius:50%;background:rgba(255,255,255,.2);
margin:0 10px;color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;user-select:none;}
#nitroBar{width:100px;height:6px;background:#333;margin-top:4px;}
#nitroFill{width:100%;height:100%;background:#0f0;}
</style>
</head>
<body>

<div id="hud">
Speed: <span id="speed">0</span>
<div id="nitroBar"><div id="nitroFill"></div></div>
</div>

<div id="btns">
<div class="button" id="left">◀</div>
<div class="button" id="gas">▲</div>
<div class="button" id="right">▶</div>
<div class="button" id="brake">▼</div>
<div class="button" id="nitro">⚡</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
/* ===== SCENE ===== */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x000000);
scene.fog=new THREE.Fog(0x000000,20,150);

/* ===== CAMERA & RENDERER ===== */
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,500);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

/* ===== LIGHT ===== */
scene.add(new THREE.HemisphereLight(0xffffff,0x222222,1));

/* ===== ROAD ===== */
const road=new THREE.Mesh(
  new THREE.PlaneGeometry(500,30),
  new THREE.MeshBasicMaterial({color:0x222222})
);
road.rotation.x=-Math.PI/2;
scene.add(road);

/* ===== CAR ===== */
const car=new THREE.Group();
const body=new THREE.Mesh(
  new THREE.BoxGeometry(2,0.7,4),
  new THREE.MeshBasicMaterial({color:0xff3333})
);
body.position.y=0.5;
car.add(body);

function addWheel(x,z){
  const wheel=new THREE.Mesh(
    new THREE.CylinderGeometry(0.4,0.4,0.4,16),
    new THREE.MeshBasicMaterial({color:0x111})
  );
  wheel.rotation.z = Math.PI/2;
  wheel.position.set(x,0.2,z);
  car.add(wheel);
}
addWheel(-1,1.5); addWheel(1,1.5); addWheel(-1,-1.5); addWheel(1,-1.5);
scene.add(car);

/* ===== MOVEMENT & PHYSICS ===== */
let speed=0, steer=0, nitroPower=1;
const maxSpeed=0.3, accel=0.01, drag=0.96, nitroBoost=0.2;
let left=false,right=false,gas=false,brake=false,nitro=false;

/* ===== HUD ===== */
const spd=document.getElementById("speed");
const nitroFill=document.getElementById("nitroFill");

/* ===== PARTICLE SYSTEM (Nitro) ===== */
const particles=[];
const particleGeo=new THREE.SphereGeometry(0.05,4,4);
const particleMat=new THREE.MeshBasicMaterial({color:0x00ffff});
for(let i=0;i<50;i++){
  const p=new THREE.Mesh(particleGeo,particleMat);
  p.visible=false;
  scene.add(p);
  particles.push(p);
}

/* ===== INPUT ===== */
const controls=[
  {id:'left',varName:'left'},
  {id:'right',varName:'right'},
  {id:'gas',varName:'gas'},
  {id:'brake',varName:'brake'},
  {id:'nitro',varName:'nitro'}
];
controls.forEach(c=>{
  const btn=document.getElementById(c.id);
  btn.addEventListener('pointerdown',()=>window[c.varName]=true);
  btn.addEventListener('pointerup',()=>window[c.varName]=false);
  btn.addEventListener('pointercancel',()=>window[c.varName]=false);
});

/* Keyboard support */
window.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft') left=true;
  if(e.key==='ArrowRight') right=true;
  if(e.key==='ArrowUp') gas=true;
  if(e.key==='ArrowDown') brake=true;
  if(e.key===' ') nitro=true;
});
window.addEventListener('keyup',e=>{
  if(e.key==='ArrowLeft') left=false;
  if(e.key==='ArrowRight') right=false;
  if(e.key==='ArrowUp') gas=false;
  if(e.key==='ArrowDown') brake=false;
  if(e.key===' ') nitro=false;
});

/* ===== ANIMATE ===== */
function animate(){
  requestAnimationFrame(animate);

  // Acceleration & braking
  if(gas) speed=Math.min(speed+accel,maxSpeed);
  if(brake) speed=Math.max(speed-accel*2,-maxSpeed/2);
  speed*=drag;

  // Nitro
  if(nitro && nitroPower>0){
    speed+=nitroBoost;
    nitroPower-=0.005;

    // Activate particles behind car
    for(let i=0;i<particles.length;i++){
      const p=particles[i];
      p.visible=true;
      p.position.set(car.position.x+(Math.random()-0.5),car.position.y*0.5,car.position.z+Math.random()*2+2);
    }
  } else {
    nitroPower=Math.min(1,nitroPower+0.002);
    particles.forEach(p=>p.visible=false);
  }

  // Steering & drift
  if(left) steer+=0.002;
  if(right) steer-=0.002;
  steer*=0.85;
  car.rotation.y += steer*speed*5;
  car.rotation.z = -steer*speed*2;
  car.translateZ(-speed*5);

  // 360° Camera rotation effect
  const camOffsetX=Math.sin(Date.now()*0.001)*2;
  const camOffsetZ=10+Math.cos(Date.now()*0.001)*2;
  camera.position.lerp(new THREE.Vector3(car.position.x+camOffsetX,4,car.position.z+camOffsetZ),0.08);
  camera.lookAt(car.position);

  // HUD update
  spd.textContent=Math.floor(speed*100);
  nitroFill.style.width=(nitroPower*100)+'%';

  renderer.render(scene,camera);
}
animate();

/* ===== RESIZE ===== */
window.addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
